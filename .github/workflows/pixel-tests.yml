name: TunService Pixel Tests
run-name: |
  ${{ github.event.inputs.update_snapshots == 'true' && 'Update baseline snapshots' || 'Pixel Tests' }}

on:
  workflow_dispatch:
    inputs:
      browser_chromium:
        description: 'Run tests in Chromium'
        required: false
        default: true
        type: boolean
      browser_webkit:
        description: 'Run tests in WebKit'
        required: false
        default: false
        type: boolean
      browser_firefox:
        description: 'Run tests in Firefox'
        required: false
        default: false
        type: boolean
      device_desktop:
        description: 'Run tests on Desktop'
        required: false
        default: true
        type: boolean
      device_mobile:
        description: 'Run tests on Mobile'
        required: false
        default: false
        type: boolean
      device_tablet:
        description: 'Run tests on Tablet'
        required: false
        default: false
        type: boolean
      update_snapshots:
        description: 'Update baseline snapshots (run first time or after intentional UI changes)'
        required: false
        default: false
        type: boolean

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Determine selected browsers and devices
        id: set-matrix
        run: |
          browsers="["
          first_browser=true

          if [ "${{ github.event.inputs.browser_chromium }}" == "true" ]; then
            if [ "$first_browser" == "true" ]; then
              browsers="$browsers\"chromium\""
              first_browser=false
            else
              browsers="$browsers,\"chromium\""
            fi
          fi

          if [ "${{ github.event.inputs.browser_webkit }}" == "true" ]; then
            if [ "$first_browser" == "true" ]; then
              browsers="$browsers\"webkit\""
              first_browser=false
            else
              browsers="$browsers,\"webkit\""
            fi
          fi

          if [ "${{ github.event.inputs.browser_firefox }}" == "true" ]; then
            if [ "$first_browser" == "true" ]; then
              browsers="$browsers\"firefox\""
              first_browser=false
            else
              browsers="$browsers,\"firefox\""
            fi
          fi

          browsers="$browsers]"

          # If no browsers selected, default to chromium
          if [ "$browsers" == "[]" ]; then
            browsers='["chromium"]'
          fi

          devices="["
          first_device=true

          if [ "${{ github.event.inputs.device_desktop }}" == "true" ]; then
            if [ "$first_device" == "true" ]; then
              devices="$devices\"desktop\""
              first_device=false
            else
              devices="$devices,\"desktop\""
            fi
          fi

          if [ "${{ github.event.inputs.device_mobile }}" == "true" ]; then
            if [ "$first_device" == "true" ]; then
              devices="$devices\"mobile\""
              first_device=false
            else
              devices="$devices,\"mobile\""
            fi
          fi

          if [ "${{ github.event.inputs.device_tablet }}" == "true" ]; then
            if [ "$first_device" == "true" ]; then
              devices="$devices\"tablet\""
              first_device=false
            else
              devices="$devices,\"tablet\""
            fi
          fi

          devices="$devices]"

          # If no devices selected, default to desktop
          if [ "$devices" == "[]" ]; then
            devices='["desktop"]'
          fi

          # Create matrix with all combinations
          matrix="{\"include\":["
          first_combination=true

          for browser in $(echo "$browsers" | tr -d '[]"' | tr ',' ' '); do
            for device in $(echo "$devices" | tr -d '[]"' | tr ',' ' '); do
              if [ "$first_combination" == "true" ]; then
                matrix="$matrix{\"browser\":\"$browser\",\"device\":\"$device\"}"
                first_combination=false
              else
                matrix="$matrix,{\"browser\":\"$browser\",\"device\":\"$device\"}"
              fi
            done
          done

          matrix="$matrix]}"

          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Selected browsers: $browsers"
          echo "Selected devices: $devices"
          echo "Matrix: $matrix"

  pixel-tests:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false

    env:
      HEADLESS: true
      CI: true
      BROWSER: ${{ matrix.browser }}
      DEVICE: ${{ matrix.device }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: "pip"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Playwright Browsers
      run: |
        playwright install --with-deps ${{ env.BROWSER }}

    - name: Run Pixel Tests
      id: run_tests
      env:
        BROWSER: ${{ env.BROWSER }}
        DEVICE: ${{ env.DEVICE }}
      run: |
        echo "Running pixel tests for $BROWSER on $DEVICE viewport"

        # Run pixel tests (marker: pixel_test)
        # --ignore-size-diff: generate diff images even when dimensions differ
        pytest tests/pixels-tests/ -v \
          --browser "$BROWSER" \
          --tb=short \
          -m pixel_test \
          --ignore-size-diff \
          --ctrf=reports/ctrf-report-${{ env.BROWSER }}-${{ env.DEVICE }}.json

    # Upload snapshots always (per plugin author's recommendation)
    # Plugin always writes snapshots on CI, so we upload them always to ensure
    # they're available even if tests fail in teardown
    - name: Upload Snapshot Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ env.BROWSER }}-${{ env.DEVICE }}
        path: |
          references/
          snapshot_failures/
        retention-days: 30

    # Upload snapshot failures separately for easier access to diffs
    - name: Upload Snapshot Failures (Diff Images)
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: snapshot-failures-${{ env.BROWSER }}-${{ env.DEVICE }}
        path: snapshot_failures/
        retention-days: 30

    - name: Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ env.BROWSER }}-${{ env.DEVICE }}
        path: |
          reports/
        retention-days: 30

    - name: Publish Test Results (CTRF)
      uses: ctrf-io/github-test-reporter@v1
      if: always()
      with:
        report-path: "./reports/ctrf-report-${{ env.BROWSER }}-${{ env.DEVICE }}.json"
        github-report: true
        summary-report: true
        failed-report: true
        test-list-report: true
        pull-request: false
        update-comment: false
        comment-tag: "pixel-${{ env.BROWSER }}-${{ env.DEVICE }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate Summary
      if: always()
      run: |
        echo "## Pixel Tests - ${{ env.BROWSER }} (${{ env.DEVICE }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… All visual regression tests passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Visual regression tests failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **snapshot-failures-${{ env.BROWSER }}-${{ env.DEVICE }}**: Diff images of failed tests (download to review changes)" >> $GITHUB_STEP_SUMMARY
          echo "- **test-results-${{ env.BROWSER }}-${{ env.DEVICE }}**: Full snapshots + diff images" >> $GITHUB_STEP_SUMMARY
          echo "- **references**: Combined baseline snapshots (download via GitHub UI)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### To update baselines:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download **references** artifact from GitHub Actions UI" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the ZIP to your project root (it contains \`references/\` folder)" >> $GITHUB_STEP_SUMMARY
          echo "3. Review and commit changes:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git add references/ && git commit -m 'Update pixel test snapshots'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi

  # Merge references from all test runs into a single artifact for easy download
  merge-references:
    name: Merge Reference Snapshots
    runs-on: ubuntu-latest
    needs: [prepare, pixel-tests]
    if: always()

    steps:
    - name: Download all test-results artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: test-results-*
        path: downloaded-artifacts

    - name: Merge references from all test runs
      run: |
        echo "ðŸ“¦ Merging references from test runs..."
        mkdir -p references

        # Copy references from each test run artifact
        for test_dir in downloaded-artifacts/test-results-*; do
          if [ -d "$test_dir/references" ]; then
            platform_name=$(basename "$test_dir" | sed 's/test-results-//')
            echo "  âœ… Copying references from $platform_name"
            cp -R "$test_dir/references/"* references/ 2>/dev/null || true
          fi
        done

        # Count snapshots
        snapshot_count=$(find references -type f -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
        echo "ðŸ“¸ Total snapshots: $snapshot_count"

    - name: Upload Combined References Artifact
      uses: actions/upload-artifact@v4
      with:
        name: references
        path: references/
        retention-days: 30
